## Summary
Go to the top floor in Jack's Frost Tower (Jack's Office) and click on the printer, which sends you to https://printer.kringlecastle.com/.

**Objective**: "Investigate the stolen Kringle Castle printer. Get shell access to read the contents of /var/spool/printer.log. What is the name of the last file printed (with a .xlsx extension)? Find Ruby Cyster in Jack's office for help with this objective."

Ruby Cyster tells you to talk to the elf on Santa's Castle's NetWars roof, who tells you to solve the Sleigh challenge behind him, then he'll give you shellcode tips. His tip is pretty useless, but here it is anyways:

<details>
  <summary>Chimney Scissorstick's Hint</summary>
  "Lastly, be careful not to overwrite any register values you need to reference later on in your shellcode."
</details>

Also, the Shellcode Primer challenge is super important because it preps you for Printer Exploitation. When you complete the Shellcode Primer, Ruby Oyster gives you some critical hints:

<details>
  <summary>Ruby Oyster's Hint</summary>
  Look at the firmware. If you append multiple files of that type, the last one is processed. "Have you heard of Hash Extension Attacks (https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks)?" If something's not working, check the output. The error messages are very verbose.
</details>

[Next Challenge](8%20-%20Kerberoasting%20on%20an%20Open%20Fire.md)\
[Back to Table of Contents](https://github.com/minispooner/SANS_KringleCon_2021_Walkthrough/blob/main/README.md)

## Steps
1. Go to https://printer.kringlecastle.com
2. Click on Firmware Upgrade
3. Click on Download current firmware
4. Read through the JSON and the hash length extension attack writeup
5. Get a shell and find the file!

<details>
  <summary>Understand the Firmware - Hint 1</summary>
  Base64 decode the JSON firmware value and look at the binary data. Is there a way to determine what kind of data it is?
</details>
<details>
  <summary>Understand the Firmware - Hint 2</summary>
  Magic numbers and common firmware installs.
</details>
<details>
  <summary>Understand the Firmware - Answer</summary>
  The base64-decoded blob is a zip file. You don't need to mess with it.
</details>


<details>
  <summary>hash_extender Hint 1</summary>
  The --append-file should be a zip with only 1 file inside (remember the elf's hint to append the same zip filetype?).
</details>
<details>
  <summary>hash_extender Hint 2</summary>
  Convert hash_extender output HEX into Base64 (https://base64.guru/converter/encode/hex) to prepare it for upload.
</details>

<details>
  <summary>Submitting the Payload - Hint 1</summary>
  Craft a new firmware.json file using the new base64 string and the new signature (secret length and algorithm remain the same).
</details>

<details>
  <summary>Answer</summary>
  Create a bash script for a reverse ngrok shell (chmod +x it)

  Name the file firmware.bin
  
  Zip it up
  
  Run hash_encoder
  
  Make a newfirmware.json file and add contents:

```
{
  "firmware":"BASE64_ENCODED(RAW_BIN_DATA_OUTPUT_FROM_HASH_EXTENDER)",
  "signature": "NEW SIGNATURE OUTPUT FROM HASH_EXTENDER OUTPUT",
  "secret_length":16,
  "algorithm":"SHA256"
}
```
</details>
